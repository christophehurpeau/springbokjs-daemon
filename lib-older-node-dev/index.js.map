{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { spawn } from 'child_process';\nimport Logger, { addConfig, levels } from 'nightingale';\nimport ConsoleLogger from 'nightingale-console';\nimport { EventEmitter } from 'events';\n\naddConfig({ key: 'springbokjs-daemon', handler: new ConsoleLogger(levels.INFO) });\n\nclass SpringbokDaemon extends EventEmitter {\n    constructor(command, args) {\n        super();\n        this.command = command;\n        this.args = args;\n        this.process = null;\n        this.stopPromise = null;\n        this.logger = new Logger('springbokjs-daemon');\n        this.logger.info(command + (args && (` ${args.join(' ')}`)));\n    }\n\n    start() {\n        if (this.process) {\n            throw new Error('Process already started');\n        }\n\n        this.logger.info('Starting...');\n\n        this.process = spawn(this.command, this.args, { env: process.env });\n        this.process.stdout.addListener('data', (data) => {\n            process.stdout.write(data);\n            this.emit('stdout', data);\n        });\n        this.process.stderr.addListener('data', (data) => {\n            process.stderr.write(data);\n            this.emit('stderr', data);\n        });\n\n        this.process.addListener('exit', (code, signal) => {\n            this.logger.warn('Exited', { code, signal });\n            this.process = null;\n        });\n    }\n\n    stop() {\n        if (!this.process) return Promise.resolve(this.stopPromise);\n\n        this.logger.info('Stopping...');\n        return this.stopPromise = new Promise(resolve => {\n            const process = this.process;\n            this.process = null;\n\n            const killTimeout = setTimeout(() => {\n                this.logger.warn('Timeout: sending SIGKILL...');\n                process.kill('SIGKILL');\n            }, 4000);\n\n            process.removeAllListeners();\n            process.addListener('exit', (code, signal) => {\n                this.logger.info('Stopped', { code, signal });\n                if (killTimeout) clearTimeout(killTimeout);\n                this.stopPromise = null;\n                resolve();\n            });\n            process.kill();\n        });\n    }\n\n    restart() {\n        this.logger.info('Restarting...');\n        return this.stop().then(() => this.start());\n    }\n\n    restartTimeout(timeout: number) {\n        return setTimeout(() => this.restart(), timeout);\n    }\n}\n\nexport default function createDaemon(command, args) {\n    return new SpringbokDaemon(command, args);\n}\n\nexport const node = args => createDaemon('node', args);\ncreateDaemon.node = node;\n"]}