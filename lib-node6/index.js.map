{"version":3,"sources":["../src/index.js"],"names":["pattern","handler","INFO","key","displayName","command","global","process","argv","args","autoRestart","SIGTERMTimeout","stopPromise","logger","info","start","Error","Promise","resolve","reject","stdio","on","code","signal","warn","debug","then","message","restart","stop","runningProcess","killTimeout","setTimeout","kill","removeAllListeners","once","clearTimeout","sendSIGUSR2"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;;;AAEA,4BAAU,EAAEA,SAAS,qBAAX,EAAkCC,SAAS,iCAAkB,oBAAOC,IAAzB,CAA3C,EAAV;;kBAWe,CAAC;AACdC,KADc;AAEdC,aAFc;AAGdC,YAAUC,OAAOC,OAAP,CAAeC,IAAf,CAAoB,CAApB,CAHI;AAIdC,WAJc;AAKdC,gBAAc,KALA;AAMdC,mBAAiB;AANH,MAAD,KAOS;AACtB,MAAIJ,UAAU,IAAd;AACA,MAAIK,cAAc,IAAlB;AACA,QAAMC,SAAS,0BAAY,qBAAoBV,MAAO,IAAGA,GAAI,EAAd,GAAkB,EAAG,EAArD,EAAwDC,WAAxD,CAAf;AACAS,SAAOC,IAAP,CAAY,SAAZ,EAAuB,EAAET,OAAF,EAAWI,IAAX,EAAvB;;AAEA,SAAO;AACLM,YAAQ;AACN,UAAIR,OAAJ,EAAa;AACX,cAAM,IAAIS,KAAJ,CAAU,yBAAV,CAAN;AACD;;AAEDH,aAAOC,IAAP,CAAY,aAAZ;AACA,aAAO,IAAIG,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtCZ,kBAAU,0BAAMF,OAAN,EAAeI,IAAf,EAAqB;AAC7BW;AAD6B,SAArB,CAAV;;AAIAb,gBAAQc,EAAR,CAAW,MAAX,EAAmB,CAACC,IAAD,EAAOC,MAAP,KAAkB;AACnCV,iBAAOW,IAAP,CAAY,QAAZ,EAAsB,EAAEF,IAAF,EAAQC,MAAR,EAAtB;AACAhB,oBAAU,IAAV;AACA,cAAIG,WAAJ,EAAiB;AACfG,mBAAOY,KAAP,CAAa,aAAb;AACA,iBAAKV,KAAL,GAAaW,IAAb,CAAkBR,OAAlB,EAA2BC,MAA3B;AACD,WAHD,MAGO;AACLA;AACD;AACF,SATD;;AAWAZ,gBAAQc,EAAR,CAAW,SAAX,EAAuBM,OAAD,IAAa;AACjC,cAAIA,YAAY,OAAhB,EAAyB;AACvBd,mBAAOC,IAAP,CAAY,SAAZ;AACAI;AACD,WAHD,MAGO,IAAIS,YAAY,SAAhB,EAA2B;AAChC,iBAAKC,OAAL;AACD,WAFM,MAEA;AACLf,mBAAOC,IAAP,CAAY,SAAZ,EAAuB,EAAEa,OAAF,EAAvB;AACD;AACF,SATD;AAUD,OA1BM,CAAP;AA2BD,KAlCI;;AAoCLE,WAAO;AACL,UAAI,CAACtB,OAAL,EAAc,OAAOU,QAAQC,OAAR,CAAgBN,WAAhB,CAAP;;AAEdC,aAAOC,IAAP,CAAY,aAAZ;AACA,aAAOF,cAAc,IAAIK,OAAJ,CAAYC,WAAW;AAC1C,cAAMY,iBAAiBvB,OAAvB;AACAA,kBAAU,IAAV;;AAEA,cAAMwB,cAAcC,WAAW,MAAM;AACnCnB,iBAAOW,IAAP,CAAY,6BAAZ;AACAM,yBAAeG,IAAf,CAAoB,SAApB;AACD,SAHmB,EAGjBtB,cAHiB,CAApB;;AAKAmB,uBAAeI,kBAAf;AACAJ,uBAAeK,IAAf,CAAoB,MAApB,EAA4B,CAACb,IAAD,EAAOC,MAAP,KAAkB;AAC5CV,iBAAOC,IAAP,CAAY,SAAZ,EAAuB,EAAEQ,IAAF,EAAQC,MAAR,EAAvB;AACA,cAAIQ,WAAJ,EAAiBK,aAAaL,WAAb;AACjBnB,wBAAc,IAAd;AACAM;AACD,SALD;AAMAY,uBAAeG,IAAf;AACD,OAjBoB,CAArB;AAkBD,KA1DI;;AA4DLL,cAAU;AACRf,aAAOC,IAAP,CAAY,eAAZ;AACA,aAAO,KAAKe,IAAL,GAAYH,IAAZ,CAAiB,MAAM,KAAKX,KAAL,EAAvB,CAAP;AACD,KA/DI;;AAiELsB,kBAAc;AACZ9B,cAAQ0B,IAAR,CAAa,SAAb;AACD;AAnEI,GAAP;AAqED,C","file":"index.js","sourcesContent":["import { spawn } from 'child_process';\nimport Logger, { addConfig, levels } from 'nightingale/src';\nimport ConsoleLogger from 'nightingale-console/src';\n\naddConfig({ pattern: /^springbokjs-daemon/, handler: new ConsoleLogger(levels.INFO) });\n\ntype OptionsType = {|\n  key: ?string,\n  displayName: ?string,\n  command: ?string,\n  args: ?Array<string | number>,\n  autoRestart: ?boolean,\n  SIGTERMTimeout: ?number,\n|};\n\nexport default ({\n  key,\n  displayName,\n  command = global.process.argv[0],\n  args = [],\n  autoRestart = false,\n  SIGTERMTimeout = 4000,\n}: OptionsType = {}) => {\n  let process = null;\n  let stopPromise = null;\n  const logger = new Logger(`springbokjs-daemon${key ? `:${key}` : ''}`, displayName);\n  logger.info('created', { command, args });\n\n  return {\n    start() {\n      if (process) {\n        throw new Error('Process already started');\n      }\n\n      logger.info('Starting...');\n      return new Promise((resolve, reject) => {\n        process = spawn(command, args, {\n          stdio: ['pipe', 'pipe', 'pipe', 'ipc'],\n        });\n\n        process.on('exit', (code, signal) => {\n          logger.warn('Exited', { code, signal });\n          process = null;\n          if (autoRestart) {\n            logger.debug('Autorestart');\n            this.start().then(resolve, reject);\n          } else {\n            reject();\n          }\n        });\n\n        process.on('message', (message) => {\n          if (message === 'ready') {\n            logger.info('Ready !');\n            resolve();\n          } else if (message === 'restart') {\n            this.restart();\n          } else {\n            logger.info('message', { message });\n          }\n        });\n      });\n    },\n\n    stop() {\n      if (!process) return Promise.resolve(stopPromise);\n\n      logger.info('Stopping...');\n      return stopPromise = new Promise(resolve => {\n        const runningProcess = process;\n        process = null;\n\n        const killTimeout = setTimeout(() => {\n          logger.warn('Timeout: sending SIGKILL...');\n          runningProcess.kill('SIGKILL');\n        }, SIGTERMTimeout);\n\n        runningProcess.removeAllListeners();\n        runningProcess.once('exit', (code, signal) => {\n          logger.info('Stopped', { code, signal });\n          if (killTimeout) clearTimeout(killTimeout);\n          stopPromise = null;\n          resolve();\n        });\n        runningProcess.kill();\n      });\n    },\n\n    restart() {\n      logger.info('Restarting...');\n      return this.stop().then(() => this.start());\n    },\n\n    sendSIGUSR2() {\n      process.kill('SIGUSR2');\n    },\n  };\n};\n"]}