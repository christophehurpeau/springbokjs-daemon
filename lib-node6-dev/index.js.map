{"version":3,"sources":["../src/index.js"],"names":["pattern","handler","INFO","OptionsType","key","displayName","command","args","autoRestart","SIGTERMTimeout","global","process","argv","stopPromise","logger","info","stop","Promise","resolve","runningProcess","killTimeout","setTimeout","warn","kill","removeAllListeners","once","code","signal","clearTimeout","start","Error","reject","stdio","on","debug","then","message","success","restart","sendSIGUSR2"],"mappings":"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","file":"index.js","sourcesContent":["import { spawn } from 'child_process';\nimport Logger, { addConfig, levels } from 'nightingale/src';\nimport ConsoleLogger from 'nightingale-console/src';\n\naddConfig({ pattern: /^springbokjs-daemon/, handler: new ConsoleLogger(levels.INFO) });\n\ntype OptionsType = {|\n  key: ?string,\n  displayName: ?string,\n  command: ?string,\n  args: ?Array<string | number>,\n  autoRestart: ?boolean,\n  SIGTERMTimeout: ?number,\n|};\n\nexport default ({\n  key,\n  displayName,\n  command = global.process.argv[0],\n  args = [],\n  autoRestart = false,\n  SIGTERMTimeout = 4000,\n}: OptionsType = {}) => {\n  let process = null;\n  let stopPromise = null;\n  const logger = new Logger(`springbokjs-daemon${key ? `:${key}` : ''}`, displayName);\n  logger.info('created', { command, args });\n\n  const stop = () => (\n    stopPromise = new Promise(resolve => {\n      const runningProcess = process;\n      process = null;\n\n      const killTimeout = setTimeout(() => {\n        logger.warn('timeout: sending SIGKILL...');\n        runningProcess.kill('SIGKILL');\n      }, SIGTERMTimeout);\n\n      runningProcess.removeAllListeners();\n      runningProcess.once('exit', (code, signal) => {\n        logger.info('stopped', { code, signal });\n        if (killTimeout) clearTimeout(killTimeout);\n        stopPromise = null;\n        resolve();\n      });\n      runningProcess.kill();\n    })\n  );\n\n  const start = () => {\n    if (process) {\n      throw new Error('Process already started');\n    }\n\n    return new Promise((resolve, reject) => {\n      process = spawn(command, args, {\n        stdio: ['inherit', 'inherit', 'inherit', 'ipc'],\n      });\n\n      process.on('exit', (code, signal) => {\n        logger.warn('exited', { code, signal });\n        process = null;\n        if (autoRestart) {\n          logger.debug('autorestart');\n          start().then(resolve, reject);\n        } else {\n          reject();\n        }\n      });\n\n      process.on('message', (message) => {\n        if (message === 'ready') {\n          logger.success('ready');\n          resolve();\n        } else if (message === 'restart') {\n          logger.info('restarting...');\n          stop().then(() => start());\n        } else {\n          logger.info('message', { message });\n        }\n      });\n    });\n  };\n\n  return {\n    start() {\n      logger.info('starting...');\n      return start();\n    },\n\n    stop() {\n      if (!process) return Promise.resolve(stopPromise);\n\n      logger.info('stopping...');\n      return stop();\n    },\n\n    restart() {\n      logger.info('restarting...');\n      return stop().then(() => start());\n    },\n\n    sendSIGUSR2() {\n      process.kill('SIGUSR2');\n    },\n  };\n};\n"]}