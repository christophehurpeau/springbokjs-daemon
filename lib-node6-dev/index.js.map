{"version":3,"sources":["../src/index.js"],"names":["pattern","handler","INFO","key","displayName","command","global","process","argv","args","cwd","autoRestart","SIGTERMTimeout","stopPromise","logger","info","stop","Promise","resolve","runningProcess","killTimeout","setTimeout","warn","kill","removeAllListeners","once","code","signal","clearTimeout","start","Error","reject","stdio","on","debug","then","message","success","restart","sendSIGUSR2"],"mappings":"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","file":"index.js","sourcesContent":["import { spawn } from 'child_process';\nimport Logger, { addConfig, levels } from 'nightingale/src';\nimport ConsoleLogger from 'nightingale-console/src';\n\naddConfig({ pattern: /^springbokjs-daemon/, handler: new ConsoleLogger(levels.INFO) });\n\ntype OptionsType = {|\n  key: ?string,\n  displayName: ?string,\n  command: ?string,\n  args: ?Array<string | number>,\n  cwd: ?string,\n  autoRestart: ?boolean,\n  SIGTERMTimeout: ?number,\n|};\n\nexport default ({\n  key,\n  displayName,\n  command = global.process.argv[0],\n  args = [],\n  cwd,\n  autoRestart = false,\n  SIGTERMTimeout = 4000,\n}: OptionsType = {}) => {\n  let process = null;\n  let stopPromise = null;\n  const logger = new Logger(`springbokjs-daemon${key ? `:${key}` : ''}`, displayName);\n  logger.info('created', { command, args });\n\n  const stop = () => {\n    if (!process) return Promise.resolve(stopPromise);\n\n    return stopPromise = new Promise((resolve) => {\n      const runningProcess = process;\n      process = null;\n\n      const killTimeout = setTimeout(() => {\n        logger.warn('timeout: sending SIGKILL...');\n        runningProcess.kill('SIGKILL');\n      }, SIGTERMTimeout);\n\n      runningProcess.removeAllListeners();\n      runningProcess.once('exit', (code, signal) => {\n        logger.info('stopped', { code, signal });\n        if (killTimeout) clearTimeout(killTimeout);\n        stopPromise = null;\n        resolve();\n      });\n      runningProcess.kill();\n    });\n  };\n\n  const start = () => {\n    if (process) {\n      throw new Error('Process already started');\n    }\n\n    return new Promise((resolve, reject) => {\n      process = spawn(command, args, {\n        cwd,\n        stdio: ['inherit', 'inherit', 'inherit', 'ipc'],\n      });\n\n      process.on('exit', (code, signal) => {\n        logger.warn('exited', { code, signal });\n        process = null;\n        if (autoRestart) {\n          logger.debug('autorestart');\n          start().then(resolve, reject);\n        } else {\n          reject();\n        }\n      });\n\n      process.on('message', (message) => {\n        if (message === 'ready') {\n          logger.success('ready');\n          resolve();\n        } else if (message === 'restart') {\n          logger.info('restarting...');\n          stop().then(() => start());\n        } else {\n          logger.info('message', { message });\n        }\n      });\n    });\n  };\n\n  return {\n    start() {\n      logger.info('starting...');\n      return start();\n    },\n\n    stop() {\n      if (!process) logger.info('stopping...');\n      return stop();\n    },\n\n    restart() {\n      logger.info('restarting...');\n      return stop().then(() => start());\n    },\n\n    sendSIGUSR2() {\n      process.kill('SIGUSR2');\n    },\n  };\n};\n"]}