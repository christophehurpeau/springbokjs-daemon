{"version":3,"file":"index-node10-dev.es.js","sources":["../src/index.ts"],"sourcesContent":["import { spawn, ChildProcess } from 'child_process';\nimport { Readable as ReadableStream } from 'stream';\nimport gracefulKill from 'graceful-kill';\nimport split from 'split';\nimport Logger, { addConfig, Level } from 'nightingale';\nimport ConsoleLogger from 'nightingale-console';\n\naddConfig({\n  pattern: /^springbokjs-daemon/,\n  handler: new ConsoleLogger(Level.INFO),\n});\n\nexport interface Options<Messages = any> {\n  key?: string;\n  displayName?: string;\n  prefixStdout?: boolean;\n  command?: string;\n  args?: (string | number)[];\n  cwd?: string;\n  env?: NodeJS.ProcessEnv;\n  autoRestart?: boolean;\n  SIGTERMTimeout?: number;\n  onMessage?: (message: Messages) => void;\n}\n\nexport interface Daemon {\n  hasExited(): boolean;\n  start(): Promise<void>;\n  // eslint-disable-next-line no-restricted-globals\n  stop(): Promise<void>;\n  restart(): Promise<void>;\n  sendSIGUSR2(): void;\n}\n\nexport default function createDaemon({\n  key,\n  displayName,\n  prefixStdout = false,\n  command = global.process.argv[0],\n  args = [],\n  cwd,\n  env,\n  autoRestart = false,\n  SIGTERMTimeout = 4000,\n  onMessage,\n}: Options = {}): Daemon {\n  let process: ChildProcess | null = null;\n  let stopPromise: Promise<void> | void;\n  const logger = new Logger(\n    `springbokjs-daemon${key ? `:${key}` : ''}`,\n    displayName,\n  );\n  logger.info('created', { command, args });\n\n  const stop = (): Promise<void> => {\n    if (!process) return Promise.resolve(stopPromise);\n\n    const runningProcess = process;\n    process = null;\n\n    runningProcess.removeAllListeners();\n    stopPromise = gracefulKill(runningProcess, SIGTERMTimeout).then(() => {\n      stopPromise = undefined;\n    });\n\n    return stopPromise as Promise<void>;\n  };\n\n  const start = (): Promise<void> => {\n    if (process) {\n      throw new Error('Process already started');\n    }\n\n    return new Promise((resolve, reject) => {\n      const stdoutOption = prefixStdout ? 'pipe' : 'inherit';\n      process = spawn(command, args as string[], {\n        cwd,\n        env,\n        stdio: ['ignore', stdoutOption, stdoutOption, 'ipc'],\n      });\n\n      if (prefixStdout) {\n        const logStreamInLogger = (\n          stream: ReadableStream | null,\n          loggerLevel: Level,\n        ) => {\n          if (!stream) return;\n          stream.pipe(split()).on('data', (line: string) => {\n            if (line.length === 0) return;\n            if (line.startsWith('{') && line.endsWith('}')) {\n              try {\n                const json: object = JSON.parse(line);\n                logger.log('', json, loggerLevel);\n                return;\n              } catch (err) {}\n            }\n\n            logger.log(line, undefined, loggerLevel);\n          });\n        };\n\n        logStreamInLogger(process.stdout, Level.NOTICE);\n        logStreamInLogger(process.stderr, Level.ERROR);\n      }\n\n      process.on('exit', (code, signal) => {\n        logger.warn('exited', { code, signal });\n        process = null;\n        if (autoRestart) {\n          logger.debug('autorestart');\n          start().then(resolve, reject);\n        } else {\n          reject();\n        }\n      });\n\n      process.on('message', (message) => {\n        if (message === 'ready') {\n          logger.success('ready');\n          if (onMessage) onMessage('ready');\n          resolve();\n        } else if (message === 'restart') {\n          logger.notice('restarting...');\n          stop().then(() => start());\n        } else if (onMessage) {\n          onMessage(message);\n        } else {\n          logger.notice('message', { message });\n        }\n      });\n    });\n  };\n\n  return {\n    hasExited(): boolean {\n      return process === null;\n    },\n\n    start() {\n      logger.notice('starting...');\n      return start();\n    },\n\n    stop() {\n      if (!process) logger.notice('stopping...');\n      return stop();\n    },\n\n    restart() {\n      logger.notice('restarting...');\n      return stop().then(() => start());\n    },\n\n    sendSIGUSR2() {\n      if (process) {\n        process.kill('SIGUSR2');\n      }\n    },\n  };\n}\n"],"names":["addConfig","pattern","handler","ConsoleLogger","Level","INFO","createDaemon","key","displayName","prefixStdout","command","global","process","argv","args","cwd","env","autoRestart","SIGTERMTimeout","onMessage","stopPromise","logger","Logger","info","stop","Promise","resolve","runningProcess","removeAllListeners","gracefulKill","then","undefined","start","Error","reject","stdoutOption","spawn","stdio","logStreamInLogger","stream","loggerLevel","pipe","split","on","line","length","startsWith","endsWith","json","JSON","parse","log","err","stdout","NOTICE","stderr","ERROR","code","signal","warn","debug","message","success","notice","hasExited","restart","sendSIGUSR2","kill"],"mappings":";;;;;;AAOAA,SAAS,CAAC;EACRC,OAAO,EAAE,qBADD;EAERC,OAAO,EAAE,IAAIC,aAAJ,CAAkBC,KAAK,CAACC,IAAxB;CAFF,CAAT;AA2BA,AAAe,SAASC,YAAT,CAAsB;EACnCC,GADmC;EAEnCC,WAFmC;EAGnCC,YAAY,GAAG,KAHoB;EAInCC,OAAO,GAAGC,MAAM,CAACC,OAAP,CAAeC,IAAf,CAAoB,CAApB,CAJyB;EAKnCC,IAAI,GAAG,EAL4B;EAMnCC,GANmC;EAOnCC,GAPmC;EAQnCC,WAAW,GAAG,KARqB;EASnCC,cAAc,GAAG,IATkB;EAUnCC;IACW,EAXE,EAWU;MACnBP,OAA4B,GAAG,IAAnC;MACIQ,WAAJ;QACMC,MAAM,GAAG,IAAIC,MAAJ,CACZ,qBAAoBf,GAAG,GAAI,IAAGA,GAAI,EAAX,GAAe,EAAG,EAD7B,EAEbC,WAFa,CAAf;EAIAa,MAAM,CAACE,IAAP,CAAY,SAAZ,EAAuB;IAAEb,OAAF;IAAWI;GAAlC;;QAEMU,IAAI,GAAG,MAAqB;QAC5B,CAACZ,OAAL,EAAc,OAAOa,OAAO,CAACC,OAAR,CAAgBN,WAAhB,CAAP;UAERO,cAAc,GAAGf,OAAvB;IACAA,OAAO,GAAG,IAAV;IAEAe,cAAc,CAACC,kBAAf;IACAR,WAAW,GAAGS,YAAY,CAACF,cAAD,EAAiBT,cAAjB,CAAZ,CAA6CY,IAA7C,CAAkD,MAAM;MACpEV,WAAW,GAAGW,SAAd;KADY,CAAd;WAIOX,WAAP;GAXF;;QAcMY,KAAK,GAAG,MAAqB;QAC7BpB,OAAJ,EAAa;YACL,IAAIqB,KAAJ,CAAU,yBAAV,CAAN;;;WAGK,IAAIR,OAAJ,CAAY,CAACC,OAAD,EAAUQ,MAAV,KAAqB;YAChCC,YAAY,GAAG1B,YAAY,GAAG,MAAH,GAAY,SAA7C;MACAG,OAAO,GAAGwB,KAAK,CAAC1B,OAAD,EAAUI,IAAV,EAA4B;QACzCC,GADyC;QAEzCC,GAFyC;QAGzCqB,KAAK,EAAE,CAAC,QAAD,EAAWF,YAAX,EAAyBA,YAAzB,EAAuC,KAAvC;OAHM,CAAf;;UAMI1B,YAAJ,EAAkB;cACV6B,iBAAiB,GAAG,CACxBC,MADwB,EAExBC,WAFwB,KAGrB;cACC,CAACD,MAAL,EAAa;UACbA,MAAM,CAACE,IAAP,CAAYC,KAAK,EAAjB,EAAqBC,EAArB,CAAwB,MAAxB,EAAiCC,IAAD,IAAkB;gBAC5CA,IAAI,CAACC,MAAL,KAAgB,CAApB,EAAuB;;gBACnBD,IAAI,CAACE,UAAL,CAAgB,GAAhB,KAAwBF,IAAI,CAACG,QAAL,CAAc,GAAd,CAA5B,EAAgD;kBAC1C;sBACIC,IAAY,GAAGC,IAAI,CAACC,KAAL,CAAWN,IAAX,CAArB;gBACAvB,MAAM,CAAC8B,GAAP,CAAW,EAAX,EAAeH,IAAf,EAAqBR,WAArB;;eAFF,CAIE,OAAOY,GAAP,EAAY;;;YAGhB/B,MAAM,CAAC8B,GAAP,CAAWP,IAAX,EAAiBb,SAAjB,EAA4BS,WAA5B;WAVF;SALF;;QAmBAF,iBAAiB,CAAC1B,OAAO,CAACyC,MAAT,EAAiBjD,KAAK,CAACkD,MAAvB,CAAjB;QACAhB,iBAAiB,CAAC1B,OAAO,CAAC2C,MAAT,EAAiBnD,KAAK,CAACoD,KAAvB,CAAjB;;;MAGF5C,OAAO,CAAC+B,EAAR,CAAW,MAAX,EAAmB,CAACc,IAAD,EAAOC,MAAP,KAAkB;QACnCrC,MAAM,CAACsC,IAAP,CAAY,QAAZ,EAAsB;UAAEF,IAAF;UAAQC;SAA9B;QACA9C,OAAO,GAAG,IAAV;;YACIK,WAAJ,EAAiB;UACfI,MAAM,CAACuC,KAAP,CAAa,aAAb;UACA5B,KAAK,GAAGF,IAAR,CAAaJ,OAAb,EAAsBQ,MAAtB;SAFF,MAGO;UACLA,MAAM;;OAPV;MAWAtB,OAAO,CAAC+B,EAAR,CAAW,SAAX,EAAuBkB,OAAD,IAAa;YAC7BA,OAAO,KAAK,OAAhB,EAAyB;UACvBxC,MAAM,CAACyC,OAAP,CAAe,OAAf;cACI3C,SAAJ,EAAeA,SAAS,CAAC,OAAD,CAAT;UACfO,OAAO;SAHT,MAIO,IAAImC,OAAO,KAAK,SAAhB,EAA2B;UAChCxC,MAAM,CAAC0C,MAAP,CAAc,eAAd;UACAvC,IAAI,GAAGM,IAAP,CAAY,MAAME,KAAK,EAAvB;SAFK,MAGA,IAAIb,SAAJ,EAAe;UACpBA,SAAS,CAAC0C,OAAD,CAAT;SADK,MAEA;UACLxC,MAAM,CAAC0C,MAAP,CAAc,SAAd,EAAyB;YAAEF;WAA3B;;OAXJ;KA3CK,CAAP;GALF;;SAiEO;IACLG,SAAS,GAAY;aACZpD,OAAO,KAAK,IAAnB;KAFG;;IAKLoB,KAAK,GAAG;MACNX,MAAM,CAAC0C,MAAP,CAAc,aAAd;aACO/B,KAAK,EAAZ;KAPG;;IAULR,IAAI,GAAG;UACD,CAACZ,OAAL,EAAcS,MAAM,CAAC0C,MAAP,CAAc,aAAd;aACPvC,IAAI,EAAX;KAZG;;IAeLyC,OAAO,GAAG;MACR5C,MAAM,CAAC0C,MAAP,CAAc,eAAd;aACOvC,IAAI,GAAGM,IAAP,CAAY,MAAME,KAAK,EAAvB,CAAP;KAjBG;;IAoBLkC,WAAW,GAAG;UACRtD,OAAJ,EAAa;QACXA,OAAO,CAACuD,IAAR,CAAa,SAAb;;;;GAtBN;;;;;"}